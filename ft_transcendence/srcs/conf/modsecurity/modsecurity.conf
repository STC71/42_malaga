# =============================================================================
# ModSecurity Core Configuration for Docker/Nginx + OWASP CRS
# Mode: Prevention (blocking)
# Logs: Enabled (audit + optional debug)
# =============================================================================

# ----------------------------------------------------------------------------
# Rule engine initialization 
# ----------------------------------------------------------------------------

# Enable ModSecurity for all transactions.
# On  = blocking mode (recommended for production once tuned)
# DetectionOnly = log only (recommended during initial tuning)
SecRuleEngine On

# ---- quick bypass for health endpoints ----
# Disable ModSecurity processing for lightweight health checks so probes
# (from load balancers or health checkers) are not blocked by other rules.
# These run at phase:1 and turn the engine off for the transaction.
SecRule REQUEST_URI "@streq /healthz" "id:100000,phase:1,pass,nolog,ctl:ruleEngine=Off,msg:'Bypass WAF for /healthz'"
SecRule REQUEST_URI "@streq /ping" "id:100001,phase:1,pass,nolog,ctl:ruleEngine=Off,msg:'Bypass WAF for /ping'"


# ----------------------------------------------------------------------------
# Audit log configuration 
# ----------------------------------------------------------------------------

# Log relevant transactions (5xx and 4xx except 404) and those marked by rules.
## Revert to logging only relevant transactions to avoid excessive logs.
SecAuditEngine RelevantOnly
## Write audit log to the workspace-mounted logs directory so host can read it
SecAuditLog /var/log/modsecurity/modsec_audit.log

# Log parts to capture full context for investigations.
SecAuditLogParts ABIJDEFHZ
# Serial logging is simplest in containers. For high throughput, consider concurrent.
SecAuditLogType Serial
SecAuditLogRelevantStatus "^(?:5|4(?!04))"


# ----------------------------------------------------------------------------
# Data and temp directories
# ----------------------------------------------------------------------------

# Temp and persistent data directories (ensure they exist and are private in the container).
SecTmpDir /tmp/modsecurity
SecDataDir /var/cache/modsecurity


# ----------------------------------------------------------------------------
# Request/response body handling
# ----------------------------------------------------------------------------

# Allow ModSecurity to inspect request bodies (e.g., POST params).
# Allow ModSecurity to inspect request bodies (e.g., POST params).
SecRequestBodyAccess On
# Response body inspection is disabled by default for performance. We previously
# enabled it temporarily to support a narrow HTML-detection rule (900222) but
# that caused unintended side-effects in upload/login flows. Revert to Off to
# restore previous behavior; prefer header-based enforcement instead.
SecResponseBodyAccess Off
# These settings only apply if SecResponseBodyAccess is enabled.
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 13107200
SecResponseBodyLimitAction ProcessPartial
# Maximum sizes to mitigate DoS via oversized bodies.
# Adjust if your app legitimately needs larger uploads.
SecRequestBodyLimit 13107200
# SecRequestBodyInMemoryLimit 131072
# Removed because ModSecurity v3+ does not support SecRequestBodyInMemoryLimit.
# Control request-body memory limits via the webserver (nginx) configuration instead.
SecRequestBodyNoFilesLimit 13107200
# Action when body exceeds limits.
# Reject is appropriate in blocking mode.
SecRequestBodyLimitAction Reject


# ----------------------------------------------------------------------------
# Default action for rules
# ----------------------------------------------------------------------------

# Defaults to DetectionOnly (log, do not block). CRS and custom rules will override as needed.
SecDefaultAction "phase:1,log,pass"
SecDefaultAction "phase:2,log,pass"


# ----------------------------------------------------------------------------
# Error handling for request body and multipart parsing
# ----------------------------------------------------------------------------

# Fail closed on request body parsing errors.
SecRule REQBODY_ERROR "!@eq 0" "id:200001,phase:2,log,msg:'Failed to parse request body'"
SecRule REQBODY_PROCESSOR_ERROR "!@eq 0" "id:200002,phase:2,log,msg:'Request body processor error'"

# Strict validation for multipart/form-data (can be set to DetectionOnly if too strict).
SecRule MULTIPART_STRICT_ERROR "!@eq 0" "id:200003,phase:2,log,msg:'Multipart request body failed strict validation (non-disruptive)'"

# Detect unmatched multipart boundaries (1 = critical mismatch).
SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" "id:200004,phase:2,log,msg:'Multipart boundary not found (non-disruptive)'"


# ----------------------------------------------------------------------------
# PCRE / Regex tuning
# ----------------------------------------------------------------------------

# Avoid potential ReDoS via excessive backtracking.
# Tune upwards if you see false positives from CRS (e.g., 2000-5000).
SecPcreMatchLimit 1000
SecPcreMatchLimitRecursion 1000

# Deny on internal ModSecurity engine flags.
SecRule TX:/^MSC_/ "!@streq 0" "id:'200005',phase:2,t:none,deny,msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'"


# ----------------------------------------------------------------------------
# Miscellaneous
# ----------------------------------------------------------------------------

# Standard form-urlencoded separator and cookie format.
SecArgumentSeparator &
SecCookieFormat 0

# Unicode mapping used by urlDecodeUni transformation.
SecUnicodeMapFile unicode.mapping 20127

# Telemetry about ModSecurity build. Disable in production to reduce info exposure.
SecStatusEngine Off


# ----------------------------------------------------------------------------
# CRS setup and custom rules
# ----------------------------------------------------------------------------

# Load CRS setup (paranoia level, thresholds, exclusions)
Include /etc/modsecurity.d/crs-setup.conf

# Load OWASP CRS rules (core protections)
#Include /opt/owasp-crs/rules/*.conf
#Include /etc/modsecurity.d/owasp-crs/crs-setup.conf
#Include /etc/modsecurity.d/owasp-crs/rules/*.conf

# Allow access to health check endpoints early (loaded before custom rules)
# This ensures small health/ping endpoints are whitelisted before stricter
# custom rules (for example host validation) run in phase:1.
SecRule REQUEST_URI "@streq /healthz" "id:200020,phase:1,pass,nolog,msg:'Allow access to health check'"
SecRule REQUEST_URI "@streq /ping" "id:200021,phase:1,pass,nolog,msg:'Allow access to ping'"

# Load your custom rules (loaded last so they can override/whitelist)
# Revert to glob include now that rules parse correctly
Include /etc/modsecurity.d/custom-rules/*.conf


# ----------------------------------------------------------------------------
# Secure defaults and baseline hardening
# ----------------------------------------------------------------------------

#SecRule REQUEST_METHOD "!^(GET|POST|HEAD|DELETE|PUT)$" \
#     "id:'200010',phase:1,deny,log,status:405,msg:'HTTP method not allowed'"

SecRule ARGS|ARGS_NAMES|REQUEST_HEADERS|REQUEST_URI|REQUEST_FILENAME "\.\./" \
     "id:'200011',phase:2,t:none,deny,log,status:403,msg:'Directory Traversal attempt'"

SecRule ARGS "(?i:(union\s+select|select.+from|insert\s+into|drop\s+table))" \
     "id:'200012',phase:2,t:none,deny,log,status:403,msg:'Possible SQL Injection'"

SecRule ARGS "(?i:(<script\b|onerror=|onload=|alert\s*\())" \
     "id:'200013',phase:2,t:none,deny,log,status:403,msg:'Possible XSS attack'"

## During tuning we don't want to outright block common clients (curl/wget/etc.).
## Change this rule to detection-only (log, pass) so tests and legitimate tooling
## using these UAs are not blocked while keeping telemetry for analysis.
SecRule REQUEST_HEADERS:User-Agent "(?i:\b(curl|wget|nikto|sqlmap|nessus|python-requests)\b)" \
     "id:'200014',phase:1,t:none,log,pass,msg:'Suspicious User-Agent detected (log only during tuning)',chain"
SecRule REQUEST_URI "!@streq /healthz" "chain"
SecRule REQUEST_URI "!@streq /ping"

SecRule ARGS_NAMES ".{50,}" \
     "id:'200015',phase:2,t:none,deny,log,status:413,msg:'Parameter name too long'"

# ----------------------------------------------------------------------------
# Error handling for request body and multipart parsing
# ----------------------------------------------------------------------------

# Cambiar el manejo de errores para que no devuelva 400 en todos los casos
SecRule REQBODY_ERROR "!@eq 0" "id:200016,phase:2,log,msg:'Failed to parse request body'"
SecRule REQBODY_PROCESSOR_ERROR "!@eq 0" "id:200017,phase:2,log,msg:'Request body processor error'"

# Cambiar la acción de rechazo a solo registrar el error
SecRule MULTIPART_STRICT_ERROR "!@eq 0" "id:200018,phase:2,log,msg:'Multipart request body failed strict validation'"
SecRule MULTIPART_UNMATCHED_BOUNDARY "!@eq 0" "id:200019,phase:2,log,msg:'Multipart boundary not found'"

# ----------------------------------------------------------------------------
# Custom Rules Section
# ----------------------------------------------------------------------------

# Permitir el acceso a health check endpoints (moved earlier to load before custom rules)

# Permitir el método OPTIONS para solicitudes CORS
SecRule REQUEST_METHOD "OPTIONS" "id:200022,phase:1,pass,nolog,msg:'Allow CORS preflight requests'"

# Asegúrate de que las reglas de detección de inyección SQL y XSS estén bien definidas
SecRule ARGS "(?i:(union\s+select|select.+from|insert\s+into|drop\s+table))" \
     "id:'200023',phase:2,t:none,deny,log,status:403,msg:'Possible SQL Injection'"

SecRule ARGS "(?i:(<script\b|onerror=|onload=|alert\s*\())" \
     "id:'200024',phase:2,t:none,deny,log,status:403,msg:'Possible XSS attack'"

# ----------------------------------------------------------------------------
# Secure defaults and baseline hardening
# ----------------------------------------------------------------------------

SecRule REQUEST_METHOD "!^(GET|POST|HEAD|DELETE|PUT|OPTIONS)$" \
     "id:'200025',phase:1,deny,log,status:405,msg:'HTTP method not allowed'"

# =============================================================================
# End of configuration
# =============================================================================



# =============================================================================
# Only for debugging - disable in production unless needed
# =============================================================================

SecDebugLog /var/log/modsecurity/modsec_debug.log

# =============================================================================
# Production = 0, Debug = 9
# =============================================================================
SecDebugLogLevel 0
# SecDebugLogLevel 9