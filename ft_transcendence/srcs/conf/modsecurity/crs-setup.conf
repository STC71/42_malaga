# -----------------------------------------------------------------------------
# OWASP CRS setup overrides (lightweight tuning starting point)
# -----------------------------------------------------------------------------
# Default actions (DetectionOnly). Change 'pass'->'deny' later if you want blocking.
# SecDefaultAction "phase:1,pass,log,t:none" "phase:2,pass,log,t:none"

# Body limits
# These directives control the maximum size of request bodies that ModSecurity will process.
# - SecRequestBodyLimit: Maximum size (in bytes) for the entire request body (including file uploads).
# - SecRequestBodyNoFilesLimit: Maximum size (in bytes) for request bodies without file uploads.
# - SecRequestBodyLimitAction: Action to take when a request exceeds the above limits ('Reject' is recommended for security).
# Adjust these values based on your application's needs to prevent denial-of-service attacks via oversized requests.
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# CRS version
SecAction "id:910001,phase:1, nolog, pass, t:none, setvar:tx.crs_setup_version=3.3.7"

# Paranoia Level:
# 1 = safe defaults, 2/3/4 = more strict (more FPs to tune)
SecAction "id:910010,phase:1, nolog, pass, t:none, setvar:tx.paranoia_level=1, setvar:tx.executing_paranoia_level=1"

# Treat static assets in DetectionOnly mode
SecAction "id:910020,phase:1, nolog, pass, t:none, setvar:tx.static_assets_detectiononly=1"

# Inbound / Outbound Anomaly thresholds:
# Block when score >= threshold. Lower = stricter (more blocking).
SecAction "id:910030,phase:1, nolog, pass, t:none, setvar:tx.inbound_anomaly_score_threshold=5, setvar:tx.outbound_anomaly_score_threshold=4"

# Health checks and CORS preflights
SecAction "id:910040,phase:1, nolog, pass, t:none, setvar:tx.allow_static_path=/static/"
SecAction "id:910041,phase:1, nolog, pass, t:none, setvar:tx.allow_healthz=1"
SecAction "id:910042,phase:1, nolog, pass, t:none, setvar:tx.allow_ping=1"
SecAction "id:910043,phase:1, nolog, pass, t:none, setvar:tx.allow_cors_preflight=1"

# The SecAction below sets the OWASP CRS paranoia level (PL).
# PL1: Default, recommended for most sites. Only blocks clear attacks.
# PL2: Stricter, blocks more suspicious patterns. May require tuning.
# PL3: Even stricter, blocks advanced/borderline cases. Higher risk of false positives.
# PL4: Maximum strictness, blocks almost anything suspicious. For high-security environments only.
# Increase the paranoia level to enhance security, but be prepared to tune rules to avoid false positives.
# Example: setvar:tx.paranoia_level=2 for PL2, setvar:tx.paranoia_level=3 for PL3, etc.
# Enforce JSON and XML processors (ModSec body parsers already enabled in modsecurity.conf)
SecAction "id:910050,phase:1,pass,nolog,t:none,setvar:tx.paranoia_level=1,setvar:tx.crs_exclusions_json=1,setvar:tx.crs_exclusions_xml=1"

# Enforce API Content-Type rules (related to custom rule 900120)
SecAction "id:910120,phase:1, nolog, pass, t:none, setvar:tx.api_enforce_content_type=1"
SecAction "id:910121,phase:1, nolog, pass, t:none, setvar:tx.api_upload_allow_multipart=1"

# Allowed content types (keep in sync with POST rule)
SecAction "id:910130,phase:1, nolog, pass, t:none, setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded|multipart/form-data|application/json|text/xml|application/xml|'"

# File extensions and request limits (tune to your app)
SecAction "id:910140,phase:1, nolog, pass, t:none, setvar:tx.max_num_args=256, setvar:tx.arg_name_length=50, setvar:tx.arg_length=64000, setvar:tx.total_arg_length=64000, setvar:tx.max_file_size=12000000, setvar:tx.combined_file_sizes=12000000"

# Early, high-priority enforcement: if the number of query/form parameters
# exceeds the configured limit, short-circuit and return 413 (Payload Too Large).
# Placing this in crs-setup ensures it runs BEFORE the OWASP CRS blocking rules
# so tests that expect a 413 will receive it instead of a generic 403.
SecRule &ARGS "@gt %{tx.max_num_args}" "id:910235,phase:1,deny,log,status:413,msg:'Too many parameters - exceeds tx.max_num_args'"

# Early enforcement for argument value or total args size: return 413 if any
# single argument OR the combined arguments size exceeds configured limits.
# This ensures oversized argument values produce a 413 before CRS blocking
# (the OWASP CRS logs them but leaves the final decision to anomaly scoring).
SecRule ARGS_COMBINED_SIZE "@gt %{tx.total_arg_length}" "id:910360,phase:2,deny,log,status:413,msg:'Arguments size exceeds tx.total_arg_length'"

# Early enforcement for argument name length: return 413 if any argument name
# exceeds the configured tx.arg_name_length so we surface 413 instead of 403.
SecRule ARGS_NAMES "@rx ^.{51,}$" "id:910236,phase:2,deny,log,status:413,msg:'Argument name too long - exceeds tx.arg_name_length'"

# Fallback: detect overly long parameter names in the REQUEST_URI (query string)
# This matches query parameter names >=51 characters and returns 413 early.
SecRule REQUEST_URI "@rx [\?&]([A-Za-z0-9_\-]{51,})=" "id:910237,phase:1,deny,log,status:413,msg:'Argument name too long (in REQUEST_URI) - exceeds tx.arg_name_length'"

# Also check QUERY_STRING (safer for GET requests where param names are in the query)
SecRule QUERY_STRING "@rx (^|&)[A-Za-z0-9_\-]{51,}=" "id:910239,phase:1,deny,log,status:413,msg:'Argument name too long (in QUERY_STRING) - exceeds tx.arg_name_length'"

# Toggle to disable ModSecurity processing for CORS preflight requests (OPTIONS with Origin header).
# Set to 1 to disable ModSecurity for CORS preflight, 0 to keep ModSecurity active.
# Related custom rule: 900150
SecAction "id:910150,phase:1,pass,nolog,setvar:tx.cors_preflight_disable=1"

# Required Accept header value for API requests (related to custom rules 900200/900201)
SecAction "id:910200,phase:1,pass,nolog,setvar:tx.api_accept=application/json"

# Allowed methods for root path (related to 900211)
SecAction "id:910211,phase:1,pass,nolog,setvar:'tx.allowed_methods_root=GET HEAD OPTIONS'"

# Allowed methods for /api/ by default (related to 900212)
SecAction "id:910212,phase:1,pass,nolog,setvar:'tx.allowed_methods_api=GET HEAD POST OPTIONS'"

# Allowed methods for /api/profiles (related to 900214)
SecAction "id:910214,phase:1,pass,nolog,setvar:'tx.allowed_methods_profiles=GET HEAD POST PUT DELETE'"

# Allowed methods for /api/items (related to 900216)
SecAction "id:910216,phase:1,pass,nolog,setvar:'tx.allowed_methods_items=GET HEAD POST PUT DELETE'"

# Allowed Content-Types for API responses (related to custom rule 900221)
SecAction "id:910221,phase:1,pass,nolog,setvar:tx.api_response_content_types=application/json|application/problem+json"

# Size limits for incoming requests (related to custom rules 900231–900233)
SecAction "id:910231,phase:1,pass,nolog,setvar:tx.max_num_args=256"
SecAction "id:910232,phase:1,pass,nolog,setvar:tx.arg_name_length=50"
SecAction "id:910233,phase:1,pass,nolog,setvar:tx.arg_length=64000"

# Allowed methods for specific endpoints (related to custom rules 900241–900243)
SecAction "id:910241,phase:1,pass,nolog,setvar:'tx.allowed_methods_auth_login=POST'"
SecAction "id:910242,phase:1,pass,nolog,setvar:'tx.allowed_methods_upload=POST'"
SecAction "id:910243,phase:1,pass,nolog,setvar:'tx.allowed_methods_non_api=GET|HEAD|OPTIONS'"

# Upload guard settings (related to custom rules 900302–900303)
SecAction "id:910302,phase:1,pass,nolog,setvar:tx.upload_content_type=multipart/form-data"
SecAction "id:910303,phase:1,pass,nolog,setvar:tx.upload_max_size=12000000"

# If a request targets /api/upload and uses an allowed POST content-type such as
# application/x-www-form-urlencoded, remove the strict upload guard rule (900302)
# for this request so body/ARGS-based checks in phase:2 can run and return 413
# for oversized argument values. This is a narrow exception and only affects
# requests matching the URI; the upload size rule (900303) still applies in phase:2.
SecRule REQUEST_URI "@rx ^/api/upload" "id:910350,phase:1,pass,nolog,t:none,chain,msg:'Allow urlencoded POST to /api/upload by removing 900302 for this tx'"
SecRule REQUEST_HEADERS:Content-Type "@rx ^(?:application/x-www-form-urlencoded|multipart/form-data|application/json)(?:;|$)" "t:none,ctl:ruleRemoveById=900302"

# Dangerous file extensions to block in /api/ (related to custom rule 900400)
SecAction "id:910400,phase:1,pass,nolog,setvar:'tx.blocked_extensions=php|jsp|asp|aspx|exe|sh|bat|cmd'"

# Login rate limiting switches (related to custom rules 900401+)
SecAction "id:910451,phase:1, nolog, pass, t:none, setvar:tx.login_ratelimit_enabled=1"
SecAction "id:910452,phase:1, nolog, pass, t:none, setvar:tx.login_ratelimit_window=60"
SecAction "id:910453,phase:1, nolog, pass, t:none, setvar:tx.login_ratelimit_maxreq=5"
SecAction "id:910454,phase:1, nolog, pass, t:none, setvar:tx.login_fail_tracking=1"

# Allowed hostnames for Host header validation
SecAction "id:910600,phase:1,nolog,pass,t:none,setvar:'tx.allowed_hostnames=.+'"



# Patterns for XSS and SQLi detection (related to custom rules 900601–900603)
# XSS pattern (detect <script>, onerror=, onload=, alert( etc.)
SecAction "id:910601,phase:1,pass,nolog,setvar:'tx.xss_pattern=<script|onerror|onload|alert('"
# SQLi word-list pattern (OR/AND/UNION/LIKE...)
SecAction "id:910602,phase:1,pass,nolog,t:none, setvar:tx.sqli_pattern=(?:or|and|union|select|insert|update|delete|drop|sleep|benchmark|like)"
# SQLi quote pattern (detect ' OR ' / " OR " etc.)
SecAction "id:910603,phase:1,pass,nolog,t:none, setvar:tx.sqli_quote_pattern=(?:'|\\\')\\s*(?:or|and)\\s*(?:'|\\\')"


# Allowed POST content-types (used by strict POST CT rule)
SecAction "id:910700,phase:1, nolog, pass, t:none, setvar:'tx.allowed_post_ct=application/x-www-form-urlencoded|multipart/form-data|application/json'"

# Allowed methods and Content-Types for /api/auth/login (related to custom rules 900701–900702)
SecAction "id:910701,phase:1,pass,nolog,setvar:'tx.auth_login_methods=GET|POST'"
SecAction "id:910702,phase:1,pass,nolog,setvar:'tx.auth_login_content_types=application/json|multipart/form-data'"

# Toggle to enforce User-Agent header presence (related to custom rule 900800)
SecAction "id:910800,phase:1,pass,nolog,setvar:tx.ua_required=1"

# RFC1918/localhost/metadata IPs (used by the SSRF rule below)
SecAction "id:910801,phase:1,pass,nolog,t:none, setvar:'tx.private_ip_regex1=127\.0\.0\.1|0\.0\.0\.0'"
SecAction "id:910802,phase:1,pass,nolog,t:none, setvar:'tx.private_ip_regex2=10\\.[0-9](?:[0-9])?(?:[0-9])?\\.[0-9](?:[0-9])?(?:[0-9])?\\.[0-9](?:[0-9])?(?:[0-9])?'"
SecAction "id:910803,phase:1,pass,nolog,t:none, setvar:'tx.private_ip_regex3=192\\.168\\.[0-9](?:[0-9])?(?:[0-9])?\\.[0-9](?:[0-9])?(?:[0-9])?'"
SecAction "id:910804,phase:1,pass,nolog,t:none, setvar:'tx.private_ip_regex4=172\\.(?:1[6-9]|2[0-9]|3[0-1])\\.[0-9](?:[0-9])?(?:[0-9])?\\.[0-9](?:[0-9])?(?:[0-9])?'"
SecAction "id:910805,phase:1,pass,nolog,t:none, setvar:'tx.private_ip_regex5=169\.254\.169\.254'"
# Combine all private IP regexes into one (used by the SSRF rule below)
SecAction "id:910809,phase:1,pass,nolog,t:none,setvar:'tx.private_ip_regex=%{tx.private_ip_regex1}|%{tx.private_ip_regex2}|%{tx.private_ip_regex3}|%{tx.private_ip_regex4}|%{tx.private_ip_regex5}'"

# Suspicious URL schemes often used for SSRF/LFI gadgets
SecAction "id:910810,phase:1, nolog, pass, t:none, setvar:'tx.bad_schemes=file|gopher|dict|smb|jar|php|expect|data'"

# LFI target paths (quick wins)
SecAction "id:910820,phase:1, nolog, pass, t:none, setvar:'tx.lfi_paths=(?:^|/)(?:etc/passwd|shadow|hosts)(?:$|[^a-z])'"

# Canary flag to confirm ModSecurity is active (related to custom rule 999900)
SecAction "id:919900,phase:1, nolog, pass, t:none, setvar:tx.demo_block_keyword=malicious"
