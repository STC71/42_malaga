# 900210 - Allowed methods by path (defaults + per-endpoint overrides)
#
# These rules enforce allowed HTTP methods per path:
# - Only GET/HEAD are allowed on the root path (/).
# - By default, only GET/HEAD/POST are allowed on /api/ endpoints.
# - For /api/profiles and /api/items, PUT and DELETE are also allowed.
# - You can override allowed methods per endpoint as needed.
#
# This helps prevent misuse of HTTP methods and reduces attack surface.

## CORS preflight handling: allow OPTIONS with an Origin header explicitly.
## Use 'allow' to skip further ModSecurity checks for preflight (only when Origin present).
SecRule REQUEST_METHOD "@streq OPTIONS" "id:900202,phase:1,allow,nolog,t:none,chain,msg:'Allow CORS preflight (OPTIONS) with Origin'"
SecRule REQUEST_HEADERS:Origin "@rx .+" "t:none"

## Avoid disabling the ModSecurity engine for other flows; the allow above is narrowly
## targeted to OPTIONS requests that include an Origin header (preflight requests).

# Only GET/HEAD in root (SPA frontend)
SecRule REQUEST_URI "^/$" "id:900211,phase:1,t:none,chain,msg:'Method not allowed in /'"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_root}" "t:none,chain"
SecRule REQUEST_METHOD "!@streq OPTIONS" "t:none"

# OVERRIDES per endpoint

# /api/profiles - also allow PUT and DELETE
# Note: this override runs BEFORE the generic /api/ method rule so the ctl will
# remove the REQUEST_METHOD target from the generic rule (900212) and avoid false 405s.
SecRule REQUEST_URI "^/api/profiles$" "id:900213,phase:1,pass,ctl:ruleRemoveTargetById=900212;REQUEST_METHOD"
# Starter has the disruptive action (deny/status); continuations only conditions.
SecRule REQUEST_URI "^/api/profiles$" "id:900214,phase:1,deny,status:405,t:none,msg:'Method not allowed on /api/profiles',chain"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_profiles}" "t:none,chain"
SecRule REQUEST_METHOD "!@streq OPTIONS" "t:none"

# /api/items and /api/items/{id} - allow PUT/DELETE
# This also needs to run before the default /api/ rule so the removal takes effect.
SecRule REQUEST_URI "^/api/items(?:/\d+)?$" "id:900215,phase:1,pass,ctl:ruleRemoveTargetById=900212;REQUEST_METHOD"
SecRule REQUEST_URI "^/api/items(?:/\d+)?$" "id:900216,phase:1,deny,status:405,t:none,msg:'Method not allowed on /api/items',chain"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_items}" "t:none,chain"
SecRule REQUEST_METHOD "!@streq OPTIONS" "t:none"

# Narrow allowance: if request targets the profiles or items endpoints and
# the method is PUT or DELETE and a CSRF token header exists, allow the
# request to pass through the WAF (this avoids race/order issues with
# ruleRemoveTargetById in some modsec setups). This is intentionally
# narrow: it requires the X-CSRF-Token header (the harness provides it).
SecRule REQUEST_URI "@rx ^/api/(?:profiles|items)(?:/\d+)?$" "id:900218,phase:1,allow,nolog,t:none,chain,msg:'Allow PUT/DELETE pass-through for specific API endpoints when CSRF token present'"
SecRule REQUEST_METHOD "@rx ^(?:PUT|DELETE)$" "t:none,chain"
SecRule &REQUEST_HEADERS:X-CSRF-Token "@gt 0" "t:none"

# In /api/ only GET/HEAD/POST by default (generic rule runs after overrides)
SecRule REQUEST_URI "@beginsWith /api/" "id:900212,phase:1,t:none,chain,msg:'Method not allowed in /api/'"
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods_api}" "t:none,chain"
SecRule REQUEST_METHOD "!@streq OPTIONS" "t:none"

# If any endpoint requires PATCH, add PATCH to the method regex for that route.
