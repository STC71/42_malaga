## Early exceptions and whitelists (loaded before other 900xxx files)
# Place narrowly scoped ctl:ruleRemoveById here so they execute before the rules
# they intend to modify. Keep these minimal to avoid unintended side-effects.

# Exempt the upload endpoint from the Accept header enforcement rules (900200/900201).
# This allows clients that send Accept: */* (common for some upload clients) to POST
# multipart/form-data to /api/upload without being blocked by the Accept enforcement.
SecRule REQUEST_URI "@streq /api/upload" "id:900100,phase:1,pass,nolog,t:none,msg:'Exempt /api/upload from Accept header enforcement (early)',ctl:ruleRemoveById=900200,ctl:ruleRemoveById=900201"

# ...existing code...

# =============================================================================
# OAuth 2.0 Flow Exceptions (a√±adido para solucionar "Invalid state" error)
# =============================================================================
# OAuth flows (Google, 42) requieren cookies especiales (state tokens) que
# pueden contener caracteres que ModSecurity considera sospechosos.
# Sin estas excepciones, las cookies de OAuth se bloquean y aparece "Invalid state".

# Regla 900010: Deshabilitar ModSecurity completamente para rutas OAuth
SecRule REQUEST_URI "@beginsWith /auth/" \
    "id:900010,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    ctl:ruleEngine=Off,\
    msg:'Bypass ModSecurity for OAuth flows'"

# Regla 900011: Remover todas las reglas personalizadas para OAuth
SecRule REQUEST_URI "@beginsWith /auth/" \
    "id:900011,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    ctl:ruleRemoveById=200000-999999,\
    msg:'Remove all custom rules for OAuth'"

# Regla 900012: Permitir cookies OAuth con caracteres especiales
SecRule REQUEST_URI "@rx ^/auth/(google|42)/(callback)?$" \
    "id:900012,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    ctl:ruleRemoveTargetById=920272;ARGS,\
    msg:'Allow OAuth state cookies'"

# Regla 900013: Permitir query parameters largos en callbacks OAuth
SecRule REQUEST_URI "@rx ^/auth/(google|42)/callback" \
    "id:900013,\
    phase:1,\
    pass,\
    nolog,\
    t:none,\
    ctl:ruleRemoveById=920300-920399,\
    msg:'Allow OAuth callback query parameters'"

# =============================================================================
# End of OAuth Exceptions
# =============================================================================