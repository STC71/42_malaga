# These rules block API requests to /api/ endpoints if the Accept header is missing or
# does not include application/json. This enforces that clients must explicitly accept
# JSON responses from the API.

## Only enforce Accept header for non-multipart requests.
## Many upload clients send Accept: */* or omit Accept; skip Accept enforcement for multipart/form-data.

# Missing Accept header -> deny (starter has disruptive actions; continuations do not)
SecRule REQUEST_URI "@beginsWith /api/" "id:900200,phase:1,deny,status:406,log,msg:'API: missing Accept header (%{tx.api_accept} required)',t:none,chain"
SecRule REQUEST_URI "!@rx ^/api/upload($|/)" "t:none,chain"
SecRule &REQUEST_HEADERS:Accept "@eq 0" "t:none,chain"
SecRule REQUEST_HEADERS:Content-Type "!@rx ^multipart/form-data(?:;|$)" "t:none"

# Invalid Accept header -> deny (starter has disruptive actions; continuations do not)
SecRule REQUEST_URI "@beginsWith /api/" "id:900201,phase:1,deny,status:406,log,msg:'API: invalid Accept header (%{tx.api_accept} required)',t:none,chain"
SecRule REQUEST_URI "!@rx ^/api/upload($|/)" "t:none,chain"
SecRule REQUEST_HEADERS:Content-Type "!@rx ^multipart/form-data(?:;|$)" "t:none,chain"
# Allow explicit application/json or a permissive '*/*' Accept header (some clients send */* by default).
SecRule REQUEST_HEADERS:Accept "!@rx (?:%{tx.api_accept}\b|\*\/\*)" "t:none"
