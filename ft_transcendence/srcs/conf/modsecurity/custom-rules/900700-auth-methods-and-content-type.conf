# This rule blocks POST requests with a Content-Type not in the allowed list.
# The allowed Content-Types are defined in crs-setup.conf as tx.allowed_post_ct.
SecRule REQUEST_METHOD "POST" "id:900700,phase:1,deny,log,status:415,msg:'Unsupported Content-Type for POST',t:none,chain"
SecRule REQUEST_HEADERS:Content-Type "!@rx ^(?:%{tx.allowed_post_ct})(?:;|$)" "t:none"

# This rule blocks any request to /api/auth/login that does not use GET or POST methods.
# It helps enforce that only GET and POST are allowed for the login endpoint.
SecRule REQUEST_URI "@streq /api/auth/login" "id:900701,phase:1,deny,status:405,log,msg:'/api/auth/login only allows GET and POST',t:none,chain"
SecRule REQUEST_METHOD "!@rx ^(?:%{tx.auth_login_methods})$" "t:none"

# This rule blocks POST requests with an unsupported Content-Type.
# Only application/json and multipart/form-data are allowed for POST requests.
## Apply Content-Type restriction only to the login endpoint.
## This avoids blocking valid application/x-www-form-urlencoded
## POSTs to other endpoints such as /api/upload.
SecRule REQUEST_URI "@streq /api/auth/login" "id:900702,phase:1,deny,log,status:415,msg:'Unsupported Content-Type for /api/auth/login',t:none,chain"
SecRule REQUEST_HEADERS:Content-Type "!@rx ^(?:%{tx.auth_login_content_types})(?:;|$)" "t:none"
