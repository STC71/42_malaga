## Narrow enforcement: target only /api/ endpoints that return a 404 HTML
## response (not JSON). This is intentionally conservative to avoid impacting
## uploads, auth endpoints and other legitimate API flows.
## Requirements: SecResponseBodyAccess must be On for HTML detection to work.

# Phase: response inspection (phase:3). Chain conditions:
#  - request URI begins with /api/
#  - request URI is NOT one of the known upload/auth endpoints we exempt
#  - response status is exactly 404 (we leave 413/429 etc untouched)
#  - response Content-Type is not one of tx.api_response_content_types
#  - response body looks like HTML (simple heuristic)
SecRule REQUEST_URI "@beginsWith /api/" \
  "id:900222,phase:3,deny,log,status:406,msg:'API must return JSON (404 returned HTML)',t:none,chain"
SecRule REQUEST_URI "!@rx ^/api/(?:upload($|/)|(?:auth/(?:login|register|forgot-password|reset-password)$)|login$)" "t:none,chain"
SecRule RESPONSE_STATUS "@streq 404" "chain"
SecRule RESPONSE_HEADERS:Content-Type "!@rx ^(?:%{tx.api_response_content_types})\b" "t:none,chain"
SecRule RESPONSE_BODY "@rx (?i)</?html|<head|<body" "t:none"

