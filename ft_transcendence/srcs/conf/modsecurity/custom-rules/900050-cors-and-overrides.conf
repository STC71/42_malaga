### 900050-cors-and-overrides.conf
### Early, narrow exceptions to make CORS preflight and endpoint-specific overrides effective.
### These run in phase:1 so they execute before the generic /api method/accept enforcement rules.

## Allow CORS preflight (OPTIONS) when an Origin header is present: remove method and Accept checks
SecRule REQUEST_METHOD "@streq OPTIONS" "phase:1,chain,id:900060,pass,nolog,msg:'Allow CORS preflight - remove method+accept checks'"
SecRule REQUEST_HEADERS:Origin "@rx .+" "ctl:ruleRemoveTargetById=900212;REQUEST_METHOD,ctl:ruleRemoveById=900201,ctl:ruleRemoveById=900200,ctl:ruleRemoveById=900211"

# If OPTIONS + Origin, short-circuit and disable the ModSecurity engine for this transaction
# to fully allow CORS preflight flows. This is narrow (only OPTIONS with Origin) and avoids
# method/Accept enforcement from firing on preflight requests.
SecRule REQUEST_METHOD "@streq OPTIONS" "phase:1,chain,id:900065,pass,nolog,msg:'CORS preflight - disable rule engine for OPTIONS with Origin',ctl:ruleEngine=Off"
SecRule REQUEST_HEADERS:Origin "@rx .+" "t:none"

# Endpoint override: /api/profiles — remove the generic /api method check for this endpoint
SecRule REQUEST_URI "@rx ^/api/profiles($|/)" "phase:1,pass,id:900061,nolog,msg:'Override: allow methods on /api/profiles',ctl:ruleRemoveTargetById=900212;REQUEST_METHOD,ctl:ruleRemoveById=900201,ctl:ruleRemoveById=900200"

# Endpoint override: /api/items (including numeric items like /api/items/123)
SecRule REQUEST_URI "@rx ^/api/items($|/)" "phase:1,pass,id:900062,nolog,msg:'Override: allow methods on /api/items',ctl:ruleRemoveTargetById=900212;REQUEST_METHOD,ctl:ruleRemoveById=900201,ctl:ruleRemoveById=900200"

# /api/upload: remove Accept enforcement (900200/900201) and CSRF (900500) early so multipart uploads are accepted
# and CSRF header checks don't block non-browser upload clients. Keep upload-guard rules (9003xx)
# active so dangerous extensions and size limits remain enforced.
SecRule REQUEST_URI "@rx ^/api/upload($|/)" "phase:1,pass,id:900063,nolog,msg:'Upload endpoint exception - remove Accept, response JSON and CSRF checks',ctl:ruleRemoveById=900201,ctl:ruleRemoveById=900200,ctl:ruleRemoveById=900221,ctl:ruleRemoveById=900500"

# Explicit exemptions for auth and legacy login endpoints: remove Accept enforcement
# This ensures API clients that don't send Accept: application/json (curl, tests) are not
# blocked on login/registration/password flows. Keep this narrow and only for auth-related URIs.
SecRule REQUEST_URI "@rx ^/api(?:/auth)?/(?:login|register|logout|forgot-password|reset-password)$" "phase:1,pass,id:900064,nolog,msg:'Auth endpoints - remove Accept enforcement',ctl:ruleRemoveById=900201,ctl:ruleRemoveById=900200,ctl:ruleRemoveById=900221"


# Narrow allow: short multipart/form-data uploads — disable ModSecurity engine for this transaction.
# This is deliberately narrow: only POST, Content-Type multipart/form-data, and on the upload endpoint.
# It avoids false positives from Accept header enforcement and lets the backend handle content checks.
## NOTE: previous approach disabled the rule engine for uploads (900064). That prevented
## upload-guard rules (dangerous extensions, size limits) from running and caused 502s.
## We remove the engine-disable rule and keep a narrow ctl-based exemption for Accept
## enforcement only (see 900063 above). This allows upload-guard rules (9003xx) to run.
# /api/user/profile: remove Accept, response JSON, and SIZE enforcement for multipart profile updates
SecRule REQUEST_URI "@streq /api/user/profile" "id:900101,phase:1,pass,nolog,t:none,msg:'Exempt /api/user/profile from Accept header and size enforcement',ctl:ruleRemoveById=900200,ctl:ruleRemoveById=900201,ctl:ruleRemoveById=900221,ctl:ruleRemoveById=900222,ctl:ruleRemoveById=900255,ctl:ruleRemoveById=900236,ctl:ruleRemoveById=900251,ctl:ruleRemoveById=900252,ctl:ruleRemoveById=900253,ctl:ruleRemoveById=900254"