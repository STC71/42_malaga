# Login rate limiting (uses variables from crs-setup.conf 910451â€“910452)
# Only apply if rate limiting is enabled
SecRule TX:login_ratelimit_enabled "@eq 1" "id:900451,phase:1,pass,nolog,t:none,chain"
    SecRule REQUEST_URI "@rx ^/api(?:/auth)?/login$" "t:none,chain"
    SecRule REQUEST_METHOD "POST" "t:none,setvar:ip.login_counter=+1,expirevar:ip.login_counter=%{tx.login_ratelimit_window}"

# Block if more than allowed attempts in the window
SecRule IP:login_counter "@gt %{tx.login_ratelimit_maxreq}" \
    "id:900452,phase:1,deny,status:429,log,msg:'Too many login attempts (rate limit exceeded)',t:none"

# Login fail tracking (uses variables from crs-setup.conf 910454)
# Only apply if fail tracking is enabled
SecRule TX:login_fail_tracking "@eq 1" "id:900453,phase:2,pass,nolog,t:none,chain"
    SecRule REQUEST_URI "^/api/auth/login$" "t:none,chain"
    SecRule REQUEST_METHOD "POST" "t:none,chain"
    SecRule RESPONSE_STATUS "@streq 401" "t:none,setvar:ip.login_fail_counter=+1,expirevar:ip.login_fail_counter=%{tx.login_ratelimit_window}"

# Block if more than 5 failed logins in the window
SecRule IP:login_fail_counter "@gt 5" \
    "id:900454,phase:2,deny,status:429,log,msg:'Too many failed login attempts (fail tracking)',t:none"
    