########################################
### Makefile for the webserv project ###
########################################

NAME = webserv
CONFIG_FILE = config/default.conf

SRCS = srcs/main.cpp \
       srcs/Server.cpp \
       srcs/Config.cpp \
       srcs/Request.cpp \
       srcs/Response.cpp \
       srcs/CGI.cpp

OBJS = $(SRCS:srcs/%.cpp=obj/%.o)

CXX = c++
CXXFLAGS = -Wall -Wextra -Werror -std=c++98 -D_GLIBCXX_USE_CXX11_ABI=0

INC = -I include

all: setup-permissions $(NAME)

$(NAME): $(OBJS)
	@echo "Compiling $(NAME)... โณ"
	@$(CXX) $(CXXFLAGS) $(OBJS) -o $(NAME)
	@echo "$(NAME) compiled successfully! ๐"
	@echo ""
	@echo "โโโ    โโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโโโโ โโโ   โโโ"
	@echo "โโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โโโ"
	@echo "โโโ โโ โโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโ   โโโ"
	@echo "โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโ โโโโ"
	@echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโ โโโโโโโ "
	@echo " โโโโโโโโ โโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโ  โโโ  โโโโโ  "
	@echo ""
	@echo "         ๐ฏ by druiz-ca, rdel-olm & sternero (2025) ๐ฏ"
	@echo ""
	@echo "๐ HTTP Server ready to serve! Execute with: ./$(NAME) $(CONFIG_FILE)"
	@echo "๐ Ready for evaluation? Try: ./evaluation.sh"
	@echo "๐๏ธ  Need Siege for evaluation? Install and run with: ./siege_test.sh"
	@echo "๐ฅ Want to stress test? Try: ./stress_tests.sh (destructive tests!)"
	@echo ""

obj/%.o: srcs/%.cpp
	@if [ ! -d obj ]; then mkdir -p obj; echo "Creating object directory obj... ๐๏ธ"; echo "Object directory created. โ"; fi
	@echo "Compiling $< into $@... ๐"
	@$(CXX) $(CXXFLAGS) $(INC) -c $< -o $@
	@echo "$< compiled into $@ successfully. โ"

setup-permissions:
	@echo "๐ง Setting up project permissions..."
	@chmod +x *.sh 2>/dev/null || true
	@if [ -f "./chmods.sh" ]; then ./chmods.sh >/dev/null 2>&1; fi
	@echo "โ Permissions configured!"

clean:
	@echo "Cleaning object files... ๐งน"
	@rm -rf obj
	@echo "Object files cleaned! โ"

fclean: clean
	@echo "Cleaning $(NAME)... ๐งน"
	@rm -f $(NAME)
	@echo "$(NAME) cleaned! โ"
	@echo "Cleaning evaluation log files... ๐๏ธ"
	@rm -f evaluation_results.log server_eval.log valgrind_detailed.log compile.log *.log
	@echo "Evaluation log files cleaned! โ"
	@echo "Cleaning siege logs directory... ๐"
	@rm -rf logs/
	@echo "Siege logs directory cleaned! โ"
	@echo "Cleaning siege configuration... โ๏ธ"
	@rm -f .siegerc
	@echo "Siege configuration cleaned! โ"
	@echo "Cleaning evaluation status files... ๐"
	@rm -f evaluation_status.md EVALUATION_STATUS.md *.md
	@echo "Evaluation status files cleaned! โ"

re: fclean all

.PHONY: all setup-permissions clean fclean re